<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solara Retail — Refund API Docs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', system-ui, sans-serif; background: #fff; color: #1a1f36; display: flex; min-height: 100vh; }

/* SIDEBAR */
.sidebar { width: 260px; min-height: 100vh; background: #0a2540; color: #e3e8ee; padding: 24px 0; position: sticky; top: 0; height: 100vh; overflow-y: auto; flex-shrink: 0; }
.sidebar-logo { padding: 0 24px 24px; font-size: 14px; font-weight: 700; color: #fff; border-bottom: 1px solid #1c3a5e; margin-bottom: 16px; }
.sidebar-section { padding: 8px 24px 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: #7b90a7; margin-top: 12px; }
.sidebar a { display: block; padding: 6px 24px; font-size: 13px; color: #a8c0d6; text-decoration: none; transition: color 0.15s, background 0.15s; border-left: 3px solid transparent; }
.sidebar a:hover, .sidebar a.active { color: #fff; background: rgba(255,255,255,0.06); border-left-color: #635bff; }
.sidebar a.sub { padding-left: 36px; font-size: 12px; color: #7b90a7; }
.sidebar a.sub:hover { color: #a8c0d6; }

/* CONTENT */
.content { flex: 1; max-width: 680px; padding: 48px 64px; }
.content h1 { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
.content h2 { font-size: 20px; font-weight: 600; margin: 48px 0 16px; padding-top: 48px; border-top: 1px solid #e3e8ee; }
.content h3 { font-size: 16px; font-weight: 600; margin: 24px 0 8px; }
.content p { font-size: 15px; line-height: 1.7; color: #3c4257; margin-bottom: 12px; }
.content ul { padding-left: 20px; margin-bottom: 12px; }
.content li { font-size: 15px; line-height: 1.8; color: #3c4257; }

/* BADGES */
.badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-right: 8px; }
.badge.post { background: #dbeafe; color: #1d4ed8; }
.badge.get { background: #d1fae5; color: #065f46; }

/* TABLES */
table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 14px; }
th { text-align: left; padding: 8px 12px; background: #f7f8fa; font-weight: 600; color: #1a1f36; border-bottom: 2px solid #e3e8ee; }
td { padding: 8px 12px; border-bottom: 1px solid #e3e8ee; color: #3c4257; vertical-align: top; }
td code, th code { background: #f0f4f8; padding: 1px 5px; border-radius: 3px; font-family: monospace; font-size: 12px; }
.required { color: #e5484d; font-size: 11px; font-weight: 600; }
.optional { color: #8898aa; font-size: 11px; }

/* CODE PANEL */
.code-panel { background: #1a1f36; border-radius: 8px; margin: 16px 0; overflow: hidden; }
.code-panel-header { padding: 10px 16px; background: #252b48; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #8898aa; }
.code-panel pre { padding: 16px; overflow-x: auto; font-size: 13px; line-height: 1.6; font-family: 'SF Mono', 'Fira Code', monospace; color: #e3e8ee; }
.copy-btn { background: none; border: 1px solid #3d4460; color: #8898aa; padding: 3px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.15s; }
.copy-btn:hover { border-color: #635bff; color: #fff; }

/* ALERT */
.alert { background: #f0f9ff; border-left: 3px solid #0ea5e9; padding: 12px 16px; border-radius: 0 6px 6px 0; margin: 16px 0; font-size: 14px; color: #0c4a6e; }

/* LAYOUT */
.layout { display: flex; width: 100%; }
.right-panel { width: 420px; flex-shrink: 0; padding: 48px 24px; background: #f7f8fa; }

@media (max-width: 1100px) {
  .right-panel { display: none; }
  .content { max-width: 100%; }
}
@media (max-width: 768px) {
  .sidebar { display: none; }
  .content { padding: 24px; }
}
</style>
</head>
<body>

<nav class="sidebar">
  <div class="sidebar-logo">&#x1F3EA; Solara Retail<br><small style="font-weight:400;color:#7b90a7">Refund API v1.0</small></div>

  <div class="sidebar-section">Getting Started</div>
  <a href="#overview">Overview</a>
  <a href="#quickstart">Quickstart</a>
  <a href="#auth">Authentication</a>
  <a href="#concepts">Core Concepts</a>

  <div class="sidebar-section">API Reference</div>
  <a href="#create-refund"><span class="badge post" style="font-size:10px">POST</span>Create Refund</a>
  <a href="#get-refund"><span class="badge get" style="font-size:10px">GET</span>Get Refund</a>
  <a href="#list-refunds"><span class="badge get" style="font-size:10px">GET</span>List Refunds</a>
  <a href="#get-transaction"><span class="badge get" style="font-size:10px">GET</span>Get Transaction</a>
  <a href="#audit"><span class="badge get" style="font-size:10px">GET</span>Audit Log</a>

  <div class="sidebar-section">Scenarios</div>
  <a href="#scenario-a" class="sub">A — Full single method</a>
  <a href="#scenario-b" class="sub">B — Split payment</a>
  <a href="#scenario-c" class="sub">C — Partial (items)</a>
  <a href="#scenario-d" class="sub">D — Installments</a>
  <a href="#scenario-e" class="sub">E — Cross-border</a>

  <div class="sidebar-section">Reference</div>
  <a href="#errors">Error Codes</a>
  <a href="#rules">Business Rules</a>
</nav>

<div class="layout">
<main class="content">

  <section id="overview">
    <h1>Refund Reconciliation API</h1>
    <p>The Solara Retail Refund API lets you issue, track, and audit refunds for LatAm e-commerce transactions. It supports five refund scenarios: full, split payment, partial (item subset), installment, and cross-border.</p>
    <p>All financial math uses <code>decimal.Decimal</code> with <code>ROUND_HALF_UP</code>. Every operation is immutably recorded in the audit log.</p>
    <div class="alert">&#x26A0;&#xFE0F; This API processes <strong>refunds only</strong>. Chargebacks, voids, and authorizations are handled by separate services.</div>
  </section>

  <section id="quickstart">
    <h2>Quickstart</h2>
    <h3>1. Get your API key</h3>
    <p>Set <code>API_KEY</code> in your <code>.env</code> file. Pass it as <code>X-API-Key</code> header on all write requests.</p>

    <h3>2. Make your first refund</h3>
    <div class="code-panel">
      <div class="code-panel-header">curl<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre>curl -X POST http://localhost:8000/api/v1/refunds \
  -H "X-API-Key: SOLARA-SECRET-2026" \
  -H "Content-Type: application/json" \
  -d '{
    "transaction_id": "TXN-REG-001",
    "operator_id": "op1",
    "reason": "customer request"
  }'</pre>
    </div>

    <h3>3. Check the audit trail</h3>
    <div class="code-panel">
      <div class="code-panel-header">curl<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre>curl http://localhost:8000/api/v1/audit?transaction_id=TXN-REG-001</pre>
    </div>
  </section>

  <section id="auth">
    <h2>Authentication</h2>
    <p>All <code>POST</code> endpoints require the <code>X-API-Key</code> header. <code>GET</code> endpoints are read-only and do not require authentication.</p>
    <div class="alert">Never pass the API key as a query parameter — it will appear in server logs.</div>
    <table>
      <tr><th>Scenario</th><th>Response</th></tr>
      <tr><td>Missing key</td><td>401 <code>UNAUTHORIZED</code></td></tr>
      <tr><td>Wrong key</td><td>401 <code>UNAUTHORIZED</code></td></tr>
      <tr><td>5 failed attempts from same IP</td><td>429 <code>RATE_LIMITED</code> for 60s</td></tr>
    </table>
  </section>

  <section id="concepts">
    <h2>Core Concepts</h2>
    <h3>Operation Taxonomy</h3>
    <table>
      <tr><th>Operation</th><th>Initiator</th><th>Money Direction</th><th>This API?</th></tr>
      <tr><td>Purchase</td><td>Merchant</td><td>Customer &#x2192; Merchant</td><td>&#x274C;</td></tr>
      <tr><td>Capture</td><td>Merchant</td><td>Completes auth</td><td>&#x274C;</td></tr>
      <tr><td><strong>Refund</strong></td><td>Merchant</td><td>Merchant &#x2192; Customer</td><td>&#x2705;</td></tr>
      <tr><td>Chargeback</td><td>Card network</td><td>Forced reversal</td><td>&#x274C;</td></tr>
      <tr><td>Void</td><td>Merchant</td><td>Pre-capture cancel</td><td>&#x274C;</td></tr>
    </table>

    <h3>Refundable Statuses</h3>
    <table>
      <tr><th>Status</th><th>Refundable?</th><th>Note</th></tr>
      <tr><td><code>CAPTURED</code></td><td>&#x2705; Yes</td><td></td></tr>
      <tr><td><code>SETTLED</code></td><td>&#x2705; Yes</td><td></td></tr>
      <tr><td><code>AUTHORIZED</code></td><td>&#x274C; No</td><td>Use void/cancel instead</td></tr>
      <tr><td><code>VOIDED</code></td><td>&#x274C; No</td><td>Already reversed</td></tr>
      <tr><td><code>CHARGEBACKED</code></td><td>&#x274C; No</td><td>Use disputes process</td></tr>
    </table>
  </section>

  <section id="create-refund">
    <h2><span class="badge post">POST</span> /api/v1/refunds</h2>
    <p>Create a new refund for a captured or settled transaction. Supports full, partial, installment, and cross-border scenarios.</p>

    <h3>Request Parameters</h3>
    <table>
      <tr><th>Parameter</th><th>Type</th><th>Required</th><th>Description</th></tr>
      <tr><td><code>transaction_id</code></td><td>string</td><td><span class="required">required</span></td><td>ID of the transaction to refund (pattern: <code>^[A-Z0-9_-]+$</code>)</td></tr>
      <tr><td><code>operator_id</code></td><td>string</td><td><span class="required">required</span></td><td>ID of the operator initiating the refund</td></tr>
      <tr><td><code>reason</code></td><td>string</td><td><span class="required">required</span></td><td>Human-readable reason (max 500 chars)</td></tr>
      <tr><td><code>item_ids</code></td><td>string[]</td><td><span class="optional">optional</span></td><td>Item IDs for partial refund. Omit for full refund. Max 100 items.</td></tr>
      <tr><td><code>idempotency_key</code></td><td>string</td><td><span class="optional">optional</span></td><td>Unique key to prevent duplicate processing</td></tr>
    </table>

    <div class="code-panel">
      <div class="code-panel-header">Response 201<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre>{
  "data": {
    "refund_id": "RF-A1B2C3D4",
    "operation_type": "REFUND",
    "transaction_id": "TXN-REG-001",
    "status": "APPROVED",
    "total_refund_amount": "64.00",
    "currency": "USD",
    "operator_id": "op1",
    "reason": "customer request",
    "calculation_breakdown": {
      "scenario": "A: Full refund, single payment method",
      "total_refund": "64.00",
      "payment_breakdown": [
        {
          "payment_id": "PAY-REG-001",
          "payment_type": "CARD",
          "original_amount": "64.00",
          "refund_amount": "64.00",
          "currency": "USD"
        }
      ]
    },
    "created_at": "2026-02-25T10:00:00Z"
  },
  "meta": {
    "timestamp": "2026-02-25T10:00:00Z",
    "request_id": "550e8400-e29b-41d4-a716-446655440000"
  }
}</pre>
    </div>
  </section>

  <section id="get-refund">
    <h2><span class="badge get">GET</span> /api/v1/refunds/{refund_id}</h2>
    <p>Retrieve a single refund by its ID.</p>
    <table>
      <tr><th>Status</th><th>Description</th></tr>
      <tr><td>200</td><td>Refund found</td></tr>
      <tr><td>404</td><td><code>REFUND_NOT_FOUND</code></td></tr>
    </table>
  </section>

  <section id="list-refunds">
    <h2><span class="badge get">GET</span> /api/v1/refunds</h2>
    <p>List all refunds. Use <code>?transaction_id=TXN-001</code> to filter by transaction.</p>
  </section>

  <section id="get-transaction">
    <h2><span class="badge get">GET</span> /api/v1/transactions/{transaction_id}</h2>
    <p>Retrieve a single transaction including its items and payment methods.</p>
  </section>

  <section id="audit">
    <h2><span class="badge get">GET</span> /api/v1/audit</h2>
    <p>Query the append-only audit log. Filter by <code>transaction_id</code> and/or <code>refund_id</code>.</p>
    <p>Every refund operation logs: REFUND_REQUESTED &#x2192; REFUND_APPROVED or REFUND_REJECTED.</p>
  </section>

  <section id="scenario-a">
    <h2>Scenario A — Full refund, single method</h2>
    <p>Refunds the exact transaction total back to the single payment method.</p>
    <div class="code-panel">
      <div class="code-panel-header">curl<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre>curl -X POST localhost:8000/api/v1/refunds \
  -H "X-API-Key: SOLARA-SECRET-2026" \
  -H "Content-Type: application/json" \
  -d '{"transaction_id":"TXN-REG-001","operator_id":"op1","reason":"customer request"}'</pre>
    </div>
  </section>

  <section id="scenario-b">
    <h2>Scenario B — Split payment</h2>
    <p>Distributes the refund proportionally across multiple payment methods based on their original weight.</p>
    <div class="code-panel">
      <div class="code-panel-header">curl<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre>curl -X POST localhost:8000/api/v1/refunds \
  -H "X-API-Key: SOLARA-SECRET-2026" \
  -H "Content-Type: application/json" \
  -d '{"transaction_id":"TXN-SPLIT-001","operator_id":"op1","reason":"damaged item"}'</pre>
    </div>
  </section>

  <section id="scenario-c">
    <h2>Scenario C — Partial refund (item subset)</h2>
    <p>Refunds a subset of items. Tax and shipping are refunded proportionally to the item ratio.</p>
    <div class="code-panel">
      <div class="code-panel-header">curl<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre>curl -X POST localhost:8000/api/v1/refunds \
  -H "X-API-Key: SOLARA-SECRET-2026" \
  -H "Content-Type: application/json" \
  -d '{
    "transaction_id": "TXN-REG-010",
    "item_ids": ["ITEM-REG-010-A"],
    "operator_id": "op2",
    "reason": "wrong size"
  }'</pre>
    </div>
  </section>

  <section id="scenario-d">
    <h2>Scenario D — Installment refund</h2>
    <p>Only charged installments are refundable. Refund = installment_value &times; installments_charged.</p>
    <div class="code-panel">
      <div class="code-panel-header">curl<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre>curl -X POST localhost:8000/api/v1/refunds \
  -H "X-API-Key: SOLARA-SECRET-2026" \
  -H "Content-Type: application/json" \
  -d '{"transaction_id":"TXN-INSTALL-001","operator_id":"op1","reason":"cancel order"}'</pre>
    </div>
  </section>

  <section id="scenario-e">
    <h2>Scenario E — Cross-border</h2>
    <p>Uses the exchange rate stored at purchase time. Response includes both local amount and USD equivalent.</p>
    <div class="code-panel">
      <div class="code-panel-header">curl<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre>curl -X POST localhost:8000/api/v1/refunds \
  -H "X-API-Key: SOLARA-SECRET-2026" \
  -H "Content-Type: application/json" \
  -d '{"transaction_id":"TXN-CROSS-001","operator_id":"op1","reason":"item not received"}'</pre>
    </div>
  </section>

  <section id="errors">
    <h2>Error Code Reference</h2>
    <table>
      <tr><th>Code</th><th>HTTP</th><th>Description</th></tr>
      <tr><td><code>TRANSACTION_NOT_FOUND</code></td><td>404</td><td>Transaction does not exist</td></tr>
      <tr><td><code>INVALID_TRANSACTION_STATUS</code></td><td>422</td><td>Status does not allow refund</td></tr>
      <tr><td><code>DUPLICATE_REFUND</code></td><td>409</td><td>A full refund already exists</td></tr>
      <tr><td><code>INVALID_ITEM_IDS</code></td><td>422</td><td>Item IDs not found in transaction</td></tr>
      <tr><td><code>REFUND_AMOUNT_EXCEEDED</code></td><td>422</td><td>Exceeds remaining refundable balance</td></tr>
      <tr><td><code>INSTALLMENT_NOT_CHARGED</code></td><td>422</td><td>No installments charged yet</td></tr>
      <tr><td><code>UNAUTHORIZED</code></td><td>401</td><td>Missing or invalid API key</td></tr>
      <tr><td><code>CALCULATION_ERROR</code></td><td>422</td><td>Financial guard triggered</td></tr>
      <tr><td><code>RATE_LIMITED</code></td><td>429</td><td>Too many failed auth attempts</td></tr>
      <tr><td><code>REQUEST_TOO_LARGE</code></td><td>413</td><td>Body exceeds 64KB</td></tr>
      <tr><td><code>INTERNAL_ERROR</code></td><td>500</td><td>Unexpected error (no details leaked)</td></tr>
    </table>
  </section>

  <section id="rules">
    <h2>Business Rules</h2>
    <ul>
      <li>Refunds are only allowed on <code>CAPTURED</code> or <code>SETTLED</code> transactions.</li>
      <li>Split payment refunds are distributed proportionally by original payment weight.</li>
      <li>Cross-border refunds use the exchange rate stored at purchase time, never a live rate.</li>
      <li>Installment refunds cover only charged installments: <code>installment_value &times; charged_count</code>.</li>
      <li>Partial refunds apply tax and shipping proportionally to the item ratio.</li>
      <li>All math uses <code>decimal.Decimal</code> with <code>ROUND_HALF_UP</code>.</li>
      <li>Audit log is append-only — entries are never modified or deleted.</li>
      <li>Deploy behind HTTPS in production. Never pass API keys in URLs.</li>
    </ul>
  </section>

</main>
</div>

<script>
function copyCode(btn) {
  const pre = btn.closest('.code-panel').querySelector('pre');
  navigator.clipboard.writeText(pre.textContent).then(() => {
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

// Highlight active sidebar link on scroll
const sections = document.querySelectorAll('section[id]');
const links = document.querySelectorAll('.sidebar a[href^="#"]');
window.addEventListener('scroll', () => {
  let current = '';
  sections.forEach(s => { if (window.scrollY >= s.offsetTop - 100) current = s.id; });
  links.forEach(l => {
    l.classList.toggle('active', l.getAttribute('href') === '#' + current);
  });
});
</script>
</body>
</html>
